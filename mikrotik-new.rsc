:local IFACE "wireguard-mikrotik";:local PRIV "2JzkFaXpaBZuq6o7b/Pw/ngl8jsz4q6pu5WoebW27lg=";:local IP "10.0.0.8/32";:local SPK "TeAAWswNEE8CjyCDwlXuLAYc3OJTqjFtrjPTtH7n8Ew=";:local HOST "157.245.40.199";:local PORT "51820";:local ALLOW "10.0.0.0/24";:local LP 51810;:for i from=0 to=32 do={:local T ($LP+$i);:if ([/interface wireguard print count-only where listen-port=$T]=0) do={:set LP $T;:set i 33}};:if ([/interface wireguard print count-only where name=$IFACE]=0) do={/interface wireguard add name=$IFACE};/interface wireguard set [find where name=$IFACE] private-key=$PRIV listen-port=$LP;/interface wireguard enable [find where name=$IFACE];:if ([/ip address print count-only where address=$IP]=0) do={/ip address add address=$IP interface=$IFACE disabled=no};:local PID [/interface wireguard peers find where interface=$IFACE public-key=$SPK];:if ([:len $PID]=0) do={/interface wireguard peers add interface=$IFACE public-key=$SPK endpoint-address=$HOST endpoint-port=$PORT allowed-address=$ALLOW persistent-keepalive=25} else={/interface wireguard peers set $PID endpoint-address=$HOST endpoint-port=$PORT allowed-address=$ALLOW persistent-keepalive=25};:if ([/ip route print count-only where dst-address=$ALLOW gateway=$IFACE]=0) do={/ip route add dst-address=$ALLOW gateway=$IFACE disabled=no};:delay 2;:local ok 0;:do {/ping 10.0.0.1 count=3 timeout=2s;:set ok 1} on-error={:set ok 0};:if ($ok=1) do={:put "OK mikrotik $IFACE $IP $LP"} else={:put "FAIL mikrotik"}